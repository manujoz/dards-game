generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Player {
  id        String   @id @default(uuid())
  nickname  String   @unique
  avatarUrl String?
  admin     Boolean  @default(false)
  password  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participations MatchParticipant[]
  modeStats      PlayerModeStats[]
  modeRatings    PlayerModeRating[]
  matchResults   MatchResult[]

  @@map("players")
}

model Device {
  id         String   @id
  name       String?
  createdAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())

  @@map("devices")
}

model DeviceConfig {
  deviceId     String   @id
  calibration String   @default("{}") // JSON
  preferences String   @default("{}") // JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("device_configs")
}

model Match {
  id        String    @id @default(uuid())
  gameId    String
  variant   String    // JSON
  format    String    // JSON
  status    String
  winnerId  String?
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  lastActivityAt DateTime?

  controllerDeviceId    String?
  controllerLeaseUntil  DateTime?

  teams        MatchTeam[]
  participants MatchParticipant[]
  throws       Throw[]
  results      MatchResult[]

  @@index([status])
  @@index([controllerDeviceId])
  @@map("matches")
}

model MatchTeam {
  id      String @id @default(uuid())
  matchId String
  name    String?
  score   Int    @default(0)
  rank    Int?

  match        Match              @relation(fields: [matchId], references: [id], onDelete: Cascade)
  matchMembers MatchParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("match_teams")
}

model MatchParticipant {
  id       String  @id @default(uuid())
  matchId  String
  teamId   String?
  playerId String
  score    Int     @default(0)
  rank     Int?

  match  Match      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team   MatchTeam? @relation(fields: [teamId], references: [id])
  player Player     @relation(fields: [playerId], references: [id])
  throws Throw[]
  results MatchResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("match_participants")
}

model Throw {
  id            String   @id @default(uuid())
  matchId       String
  participantId String
  roundIndex    Int
  throwIndex    Int
  segment       Int
  multiplier    Int
  points        Int
  x             Float
  y             Float
  isBust        Boolean
  isWin         Boolean
  isValid       Boolean
  timestamp     DateTime @default(now())

  match       Match            @relation(fields: [matchId], references: [id], onDelete: Cascade)
  participant MatchParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([participantId])
  @@map("throws")
}

model PlayerModeStats {
  id          String   @id @default(uuid())
  playerId    String
  gameId      String
  variantKey  String
  matchesPlayed Int    @default(0)
  matchesWon    Int    @default(0)
  dartsValid    Int    @default(0)
  pointsValid   Int    @default(0)
  marks         Int?
  roundsPlayed  Int    @default(0)
  lastMatchAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, gameId, variantKey])
  @@index([gameId, variantKey])
  @@index([playerId])
  @@map("player_mode_stats")
}

model PlayerModeRating {
  id           String   @id @default(uuid())
  playerId     String
  gameId       String
  variantKey   String
  ratingElo    Int      @default(1500)
  matchesPlayed Int     @default(0)
  lastMatchAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, gameId, variantKey])
  @@index([gameId, variantKey])
  @@index([playerId])
  @@map("player_mode_ratings")
}

model MatchResult {
  id            String   @id @default(uuid())
  matchId       String
  participantId String
  playerId      String
  gameId        String
  variantKey    String
  isWin         Boolean @default(false)
  dartsValid    Int     @default(0)
  pointsValid   Int     @default(0)
  marks         Int?
  roundsPlayed  Int     @default(0)
  endedAt       DateTime?
  createdAt     DateTime @default(now())

  match       Match            @relation(fields: [matchId], references: [id], onDelete: Cascade)
  participant MatchParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  player      Player           @relation(fields: [playerId], references: [id])

  @@unique([matchId, participantId])
  @@index([gameId, variantKey])
  @@index([playerId])
  @@index([matchId])
  @@map("match_results")
}
